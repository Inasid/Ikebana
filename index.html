<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ikebana Bouquet Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add p5.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background: beige;
            min-height: 100vh;
            color: #2c3e50;
        }

       .banner-container {
            width: 100%;
            height: 600px;
            position: relative;
            background: beige;
            border-bottom: none;
            overflow: hidden;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .banner-text {
            position: absolute;
            top: 50%;
            left: 50px;
        
            transform: translateY(-50%);
            z-index: 10;
            color: rgb(253, 84, 54);
            pointer-events: none;
            font-weight: bold;
        }

        .banner-text h1 {
            font-size: 6rem;
            font-weight: bold;
            margin-bottom: 10px;
            
        }

        .banner-text p {
            font-size: 1.2rem;
            opacity: 0.8;
             color: rgb(253, 84, 54);
             font-weight: 100;
        }

        .click-instruction {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: beige;
            border-style: solid;
            border-color: rgb(253, 84, 54);
            padding: 10px 15px;
            font-size: 0.9rem;
            color: rgb(253, 84, 54);
            
        }

        .main-container {
            
            display: flex;
            min-height: calc(100vh - 200px);
            max-height: 600px;
            gap: none;
            padding: 2rem;
             background: beige;
        }

        .canvas-section {
            flex: 0 0 700px;
            background: beige;
            border: solid rgb(253, 84, 54);
            border-radius: none;
            box-shadow: none;
            overflow: hidden;
        }

        .canvas-controls {
            padding: 1rem;
            background: beige;
            border-bottom: 1px solid beige;;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .canvas-controls label {
            font-weight: bold;
            color: rgb(253, 84, 54);
        }

        .color-picker {
            padding: 0.5rem;
            border: 1px solid rgb(253, 84, 54);
            border-radius: none;
            cursor: pointer;
            transition: border-color 0.3s;
            background: beige;
            color: rgb(253, 84, 54);
        }

        .color-picker:hover {
            background-color: rgb(253, 84, 54);
        }

        .download-btn {
            background: rgb(253, 84, 54);
            color: beige;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: none;
        }

        .download-btn:hover {
            transform: translateY(-1px);
            background-color: beige;
            border: solid rgb(253, 84, 54);
            color: rgb(253, 84, 54);
            
        }

        .canvas {
            width: 100%;
            height: 500px;
            background: beige;
            position: relative;
            transition: background-color 0.3s;
        }

        .canvas-text {
            position: absolute;
            top: 30px;
            left: 30px;
            width: 280px;
            z-index: 500;
            pointer-events: none;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            color: rgb(253, 84, 54);
        }

        .canvas-text h1 {
            font-size: 2.5rem;
            
            margin-bottom: 0.5rem;
            font-weight: bold;
            text-shadow: none;
            font-family: 'Georgia', serif;
        }

        .canvas-text h2 {
            font-size: 1rem;
            
            margin-bottom: 1rem;
            font-style: italic;
            font-weight: normal;
        }

        .canvas-text p {
            font-size: 0.85rem;
            line-height: 1.5;
           
            text-align: left;
        }

        .ikebana-vase {
            position: absolute;
            bottom: 0;
            left: 70%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 100%;
            height: 300px;
            pointer-events: none;
            background-image: url('final/Untitled-1_moss\ copy.png');
            background-size: contain;
            background-position: center bottom;
            background-repeat: no-repeat;
        }

        .flower-palette {
            flex: 1;
            background: beige;
            border-radius: 15px;
            box-shadow: none;
            padding: 1.5rem;
            max-height: 750px;
            overflow-y: auto;
            min-width: 300px;
        }

        .category {
            margin-bottom: 2rem;
        }

        .category h3 {
            color:rgb(253, 84, 54);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgb(253, 84, 54);
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .category-description {
            font-size: 0.9rem;
            color: rgb(253, 84, 54);
            margin-bottom: 1rem;
            font-style: italic;
        }

        .flower-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .flower-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .flower-name {
            font-size: 0.8rem;
            color: rgb(253, 84, 54);
            text-align: center;
            font-weight: 500;
        }

        .flower {
            width: 120px;
            height: 60px;
            border-radius: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid rgb(253, 84, 54);
            user-select: none;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        .flower:hover {
            transform: scale(1.1);
            box-shadow: none;
        }

        .flower:active {
            transform: scale(0.95);
        }

        /* Shin flowers - tall and elegant */
        .shin-1 { 
            background-image: url(final/Untitled-1_cherry.png);
        }
        .shin-2 { 
            background-image: url('final/Untitled-1_bamboo\ copy.png');
        }
        .shin-3 { 
            background-image: url('final/Untitled-1_eca.png');
        }
        .shin-4 { 
            background-image: url('final/Untitled-1_pine.png');
        }

        /* Soe flowers - medium height */
        .soe-1 { 
            background-image: url('final/Untitled-1_chrys.png');
        }
        .soe-2 { 
            background-image: url('final/Untitled-1_peony.png');
        }
        .soe-3 { 
            background-image: url('final/Untitled-1_iris.png');
        }
        .soe-4 { 
            background-image: url('final/Untitled-1_lily.png');
        }

        /* Tai flowers - low and grounding */
        .tai-1 { 
            background-image: url('final/Untitled-1_moss.png');
        }
        .tai-2 { 
            background-image: url('final/Untitled-1_sumire.png');
        }
        .tai-3 { 
            background-image: url('final/Untitled-1_lotus.png');
        }
        .tai-4 { 
            background-image: url('final/Untitled-1_pampas.png');
        }

        .draggable-flower {
            position: absolute;
            z-index: 10;
            cursor: move;
            user-select: none;
            width: 320px;
            height: 320px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: none;
            border-radius: 0;
            box-shadow: none;
        }

        .draggable-flower .flower-label {
            display: none;
        }

        .draggable-flower:hover {
            transform: scale(1.05);
        }

        .draggable-flower:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .flower-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #6c757d;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .canvas-section {
                flex: none;
                width: 100%;
            }
            
            .flower-options {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="banner-container">
        <div class="banner-text">
            <h1>Ikebana bouquet<br> builder</h1>
            <p>Scroll down to build bouquets guided by the <br>ikebana principles of flower arrangements!</p>
        </div>
        <div class="click-instruction">
            Click to bloom flowers
        </div>
    </div>

    <div class="main-container">
        <div class="canvas-section">
            <div class="canvas-controls">
                <label for="bg-color">Canvas Background:</label>
                <input type="color" id="bg-color" class="color-picker" value="#f8f9fa">
                <button id="download-btn" class="download-btn"> Download Arrangement</button>
            </div>
            <div class="canvas" id="canvas">
                <div class="canvas-text">
                    <h1>Ikebana</h1>
                    <h2>The Japanese art of flower arrangement</h2>
                    <p>Ikebana (生け花) is the Japanese art of flower arrangement that balances line, space, and seasonality. Rooted in simplicity and harmony, it reflects the connection between heaven, human, and earth, finding beauty in both flowers and the empty space around them.</p>
                </div>
                <div class="ikebana-vase">
                    <div class="vase-body">
                        <div class="vase-neck"></div>
                        <div class="vase-decoration"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flower-palette">
            <div class="category">
                <h3>Shin (真) - Heaven</h3>
                <div class="category-description">Primary line - tall, reaching upward</div>
                <div class="flower-options">
                    <div class="flower-container">
                        <div class="flower shin-1" data-type="shin" data-name="Cherry Blossom"></div>
                        <div class="flower-name">Cherry Blossom</div>
                    </div>
                    <div class="flower-container">
                        <div class="flower shin-2" data-type="shin" data-name="Bamboo"></div>
                        <div class="flower-name">Bamboo</div>
                    </div>
                    <div class="flower-container">
                        <div class="flower shin-3" data-type="shin" data-name="Eucalyptus"></div>
                        <div class="flower-name">Eucalyptus</div>
                    </div>
                    <div class="flower-container">
                        <div class="flower shin-4" data-type="shin" data-name="Pine"></div>
                        <div class="flower-name">Pine</div>
                    </div>
                </div>
            </div>

            <div class="category">
                <h3>Soe (副) - Man</h3>
                <div class="category-description">Supporting line - medium height, harmony</div>
                <div class="flower-options">
                    <div class="flower-container">
                        <div class="flower soe-1" data-type="soe" data-name="Chrysanthemum"></div>
                        <div class="flower-name">Chrysanthemum</div>
                    </div>
                    <div class="flower-container">
                        <div class="flower soe-2" data-type="soe" data-name="Peony"></div>
                        <div class="flower-name">Peony</div>
                    </div>
                    <div class="flower-container">
                        <div class="flower soe-3" data-type="soe" data-name="Iris"></div>
                        <div class="flower-name">Iris</div>
                    </div>
                    <div class="flower-container">
                        <div class="flower soe-4" data-type="soe" data-name="Lily"></div>
                        <div class="flower-name">Lily</div>
                    </div>
                </div>
            </div>

            <div class="category">
                <h3>Tai (体) - Earth</h3>
                <div class="category-description">Grounding line - low, stable foundation</div>
                <div class="flower-options">
                    <div class="flower-container">
                        <div class="flower tai-1" data-type="tai" data-name="Moss"></div>
                        <div class="flower-name">Moss</div>
                    </div>
                    <div class="flower-container">
                        <div class="flower tai-2" data-type="tai" data-name="Weed"></div>
                        <div class="flower-name">Weed</div>
                    </div>
                    <div class="flower-container">
                        <div class="flower tai-3" data-type="tai" data-name="Lotus"></div>
                        <div class="flower-name">Lotus</div>
                    </div>
                    <div class="flower-container">
                        <div class="flower tai-4" data-type="tai" data-name="Baby's breath"></div>
                        <div class="flower-name">Baby's breath</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Banner p5.js sketch using instance mode
        const bannerSketch = (p) => {
            let bannerFlowers = [];
            let bannerCanvasHeight = 600;
            let bannerP5Canvas;
            
            // Define your 3 petal colors and 3 center colors here
            const petalColors = [
                [229, 193, 183], // Light Pink
                [228, 152, 128], // Peach
                [253, 84, 54]  // Red
            ];
            
            const centerColors = [
               
                [165, 84, 68]    // Fire Brick
            ];
            
            p.setup = () => {
                bannerP5Canvas = p.createCanvas(window.innerWidth, bannerCanvasHeight);
                bannerP5Canvas.parent(document.querySelector('.banner-container'));
                bannerP5Canvas.canvas.style.position = 'absolute';
                bannerP5Canvas.canvas.style.top = '0';
                bannerP5Canvas.canvas.style.left = '0';
                bannerP5Canvas.canvas.style.zIndex = '5';
                p.noLoop();
            };
            
            p.draw = () => {
                p.clear();
                
                for (let bannerFlower of bannerFlowers) {
                    drawBannerFlower(bannerFlower.x, bannerFlower.y, bannerFlower.size, bannerFlower.color, bannerFlower.centerColor);
                }
            };
            
            const drawBannerFlower = (flowerX, flowerY, flowerSize, petalColorArray, centerColorArray) => {
                p.push();
                p.translate(flowerX, flowerY);
                
                p.fill(petalColorArray[0], petalColorArray[1], petalColorArray[2]);
                p.noStroke();
                
                for (let petalIndex = 0; petalIndex < 5; petalIndex++) {
                    p.push();
                    p.rotate(p.TWO_PI * petalIndex / 5);
                    p.ellipse(0, -flowerSize/2, flowerSize/2, flowerSize);
                    p.pop();
                }
                
                p.fill(centerColorArray[0], centerColorArray[1], centerColorArray[2]);
                p.circle(0, 0, flowerSize/3);
                
                p.pop();
            };
            
            p.mousePressed = () => {
                if (p.mouseY >= 0 && p.mouseY <= bannerCanvasHeight && p.mouseX >= 0 && p.mouseX <= p.width) {
                    // Pick random colors from your defined sets
                    const randomPetalColor = petalColors[Math.floor(Math.random() * petalColors.length)];
                    const randomCenterColor = centerColors[Math.floor(Math.random() * centerColors.length)];
                    
                    let newBannerFlower = {
                        x: p.mouseX,
                        y: p.mouseY,
                        size: p.random(30, 60),
                        color: randomPetalColor,
                        centerColor: randomCenterColor
                    };
                    
                    bannerFlowers.push(newBannerFlower);
                    p.redraw();
                    return false;
                }
            };
            
            p.windowResized = () => {
                p.resizeCanvas(window.innerWidth, bannerCanvasHeight);
                p.redraw();
            };
        };

        // Create the banner p5 instance
        new p5(bannerSketch);

        // Initialize flower counter
        let flowerCounter = 0;

        // Canvas background color changer
        const colorPicker = document.getElementById('bg-color');
        const canvas = document.getElementById('canvas');

        colorPicker.addEventListener('change', (e) => {
            canvas.style.backgroundColor = e.target.value;
        });

        // Add click functionality to original flowers
        document.querySelectorAll('.flower').forEach(flower => {
            flower.addEventListener('click', plantFlower);
            flower.addEventListener('dragstart', e => e.preventDefault());
        });

        function plantFlower(e) {
            e.preventDefault();
            
            const originalFlower = e.target;
            const flowerCopy = originalFlower.cloneNode(true);
            
            // Set up the copy for canvas
            flowerCopy.classList.add('draggable-flower');
            flowerCopy.id = 'flower-' + (++flowerCounter);
            
            // Add label
            const label = document.createElement('div');
            label.className = 'flower-label';
            label.textContent = originalFlower.dataset.name;
            flowerCopy.appendChild(label);
            
            // Position randomly in canvas (avoiding vase area at bottom)
            const canvasWidth = canvas.offsetWidth;
            const canvasHeight = canvas.offsetHeight;
            const randomX = Math.random() * (canvasWidth - 120);
            const randomY = Math.random() * (canvasHeight - 180);
            
            flowerCopy.style.position = 'absolute';
            flowerCopy.style.left = randomX + 'px';
            flowerCopy.style.top = randomY + 'px';
            flowerCopy.style.cursor = 'move';
            
            canvas.appendChild(flowerCopy);
            
            // Add double-click to remove
            flowerCopy.addEventListener('dblclick', function() {
                this.remove();
            });
            
            // Make it draggable within canvas
            makeDraggableInCanvas(flowerCopy);
        }

        function makeDraggableInCanvas(element) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            
            element.addEventListener('mousedown', function(e) {
                if (e.detail === 2) return; // Ignore double-click
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = parseInt(element.style.left);
                initialTop = parseInt(element.style.top);
                
                element.style.cursor = 'grabbing';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                let newLeft = initialLeft + deltaX;
                let newTop = initialTop + deltaY;
                
                // Keep within canvas bounds
                const canvasRect = canvas.getBoundingClientRect();
                const elementRect = element.getBoundingClientRect();
                
                newLeft = Math.max(0, Math.min(newLeft, canvas.offsetWidth - 120));
                newTop = Math.max(0, Math.min(newTop, canvas.offsetHeight - 120));
                
                element.style.left = newLeft + 'px';
                element.style.top = newTop + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    element.style.cursor = 'move';
                }
            });
        }

        // Prevent default drag behavior on images/emojis
        document.addEventListener('dragstart', e => e.preventDefault());

        // Download functionality - simplified approach
        document.getElementById('download-btn').addEventListener('click', function() {
            const canvas = document.getElementById('canvas');
            const button = this;
            
            // Show loading state
            button.textContent = '📷 Capturing...';
            button.disabled = true;
            
            // Simple approach - just capture what's visible
            setTimeout(() => {
                html2canvas(canvas, {
                    backgroundColor: canvas.style.backgroundColor || '#f8f9fa',
                    scale: 1, // Reduced scale to avoid memory issues
                    useCORS: false,
                    allowTaint: true,
                    height: canvas.offsetHeight,
                    width: canvas.offsetWidth,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: canvas.offsetWidth,
                    windowHeight: canvas.offsetHeight
                }).then(function(capturedCanvas) {
                    try {
                        // Simple dataURL approach
                        const dataURL = capturedCanvas.toDataURL('image/png', 0.9);
                        
                        // Create and trigger download
                        const link = document.createElement('a');
                        link.download = 'ikebana-' + Date.now() + '.png';
                        link.href = dataURL;
                        
                        // Force download
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        console.log('Download completed successfully');
                        
                    } catch (error) {
                        console.error('Download creation error:', error);
                        
                        // Fallback: try opening in new window
                        try {
                            const dataURL = capturedCanvas.toDataURL('image/png', 0.9);
                            const newWindow = window.open();
                            newWindow.document.write(`
                                <img src="${dataURL}" style="max-width:100%; height:auto;">
                                <br><br>
                                <p>Right-click the image above and select "Save image as..." to download.</p>
                            `);
                        } catch (fallbackError) {
                            alert('Download failed. Please try refreshing the page. Error: ' + error.message);
                        }
                    }
                    
                    // Reset button
                    button.textContent = '📷 Download Arrangement';
                    button.disabled = false;
                    
                }).catch(function(captureError) {
                    console.error('Capture error:', captureError);
                    
                    // Last resort - try without any special options
                    html2canvas(canvas).then(function(basicCanvas) {
                        try {
                            const link = document.createElement('a');
                            link.download = 'ikebana-basic-' + Date.now() + '.png';
                            link.href = basicCanvas.toDataURL('image/png');
                            
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            console.log('Basic download completed');
                            
                        } catch (basicError) {
                            console.error('All download methods failed:', basicError);
                            alert('Download failed. Please try: 1) Refreshing the page, 2) Using a different browser, or 3) Taking a screenshot manually.');
                        }
                        
                        button.textContent = '📷 Download Arrangement';
                        button.disabled = false;
                        
                    }).catch(function(basicCaptureError) {
                        console.error('Basic capture also failed:', basicCaptureError);
                        alert('Capture failed entirely. Please take a screenshot manually (Ctrl+Shift+S or Cmd+Shift+4).');
                        
                        button.textContent = '📷 Download Arrangement';
                        button.disabled = false;
                    });
                });
            }, 500); // Longer delay to ensure rendering is complete
        });
    </script>
</body>
</html>